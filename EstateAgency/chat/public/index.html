<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>èŠå¤©å®¤ç™»å…¥ç³»çµ±</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ç™»å…¥é é¢ -->
  <div class="login-page" id="loginPage">
    <h2>è«‹ç™»å…¥</h2>
    <input type="text" id="loginName" placeholder="è«‹è¼¸å…¥ä½ çš„å¸³è™Ÿ" />
    <input type="text" id="targetName" placeholder="è«‹è¼¸å…¥èŠå¤©å°è±¡å¸³è™Ÿ" />
    <button onclick="login()">ç™»å…¥</button>
  </div>

  <!-- èŠå¤©å®¤é é¢ -->
  <div class="chat-container hidden" id="chatPage">
    <div class="chat-header">
      <span id="chatTitle">èŠå¤©å®¤</span>
      <span class="user-label" id="currentUser"></span>
    </div>
    <div id="chat" class="chat-box"></div>
    <div class="input-area">
      <input type="text" id="message" placeholder="è¼¸å…¥è¨Šæ¯..." />
      <button onclick="sendMessage()">é€å‡º</button>
    </div>
  </div>

  <script>
    let currentUsername = '';
let currentTarget = '';
const socket = new WebSocket('ws://localhost:8080'); // é€£æ¥ WebSocket Server
const chat = document.getElementById('chat');

let pendingMessages = []; // ğŸ”¥ æš«å­˜è¨Šæ¯ç”¨ï¼

socket.onmessage = (e) => {
  try {
    const data = JSON.parse(e.data);

    // âš¡ ç™»å…¥å‰æ”¶åˆ°çš„å…ˆæš«å­˜
    if (!currentUsername || !currentTarget) {
      pendingMessages.push(data);
      return;
    }

    // âš¡ ç™»å…¥å¾Œï¼Œæ­£å¸¸é¡¯ç¤º
    if (
      (data.username === currentUsername && data.to === currentTarget) ||
      (data.username === currentTarget && data.to === currentUsername)
    ) {
      displayMessage(data);
    }
  } catch (error) {
    console.error('è§£æè¨Šæ¯å¤±æ•—ï¼š', error);
  }
};

function sendMessage() {
  const message = document.getElementById('message').value.trim();
  if (message && currentUsername && currentTarget) {
    const payload = {
      username: currentUsername,
      to: currentTarget,
      message: message
    };
    socket.send(JSON.stringify(payload));
    document.getElementById('message').value = '';
  } else {
    alert('è¨Šæ¯æˆ–ç™»å…¥è³‡æ–™æœ‰å•é¡Œï¼');
  }
}

function login() {
  const name = document.getElementById('loginName').value.trim();
  const target = document.getElementById('targetName').value.trim();
  if (name && target) {
    currentUsername = name;
    currentTarget = target;
    document.getElementById('currentUser').textContent = `ä½¿ç”¨è€…ï¼š${name}`;
    document.getElementById('chatTitle').textContent = `ä½ æ­£åœ¨å’Œã€${target}ã€‘èŠå¤©`;
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('chatPage').classList.remove('hidden');

    // ğŸ”¥ ç™»å…¥å¾Œï¼ŒæŠŠæš«å­˜çš„æ­·å²è¨Šæ¯æ‰¹é‡é¡¯ç¤º
    pendingMessages.forEach(data => {
      if (
        (data.username === currentUsername && data.to === currentTarget) ||
        (data.username === currentTarget && data.to === currentUsername)
      ) {
        displayMessage(data);
      }
    });
    pendingMessages = []; // æ¸…ç©ºæš«å­˜
  } else {
    alert('è«‹è¼¸å…¥ä½ çš„å¸³è™Ÿå’ŒèŠå¤©å°è±¡ï¼');
  }
}

function displayMessage(data) {
  const div = document.createElement('div');
  const isSelf = data.username === currentUsername;
  div.classList.add('bubble', isSelf ? 'me' : 'other');
  div.innerHTML = `<strong>${data.username}</strong><br>${data.message}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

  </script>
</body>
</html>
